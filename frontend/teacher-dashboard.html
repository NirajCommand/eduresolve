<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teacher Dashboard | EduResolve</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="teacher_style.css">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="dark-mode">

<!-- NAVBAR -->
<nav class="navbar-custom">
  <div class="logo">
    <i class="fa-solid fa-graduation-cap"></i> EduResolve
  </div>

  <div class="nav-center">
    <a href="#">Account</a>
    <a href="#">My Courses</a>
    <a href="#">Search</a>
  </div>

  <div class="nav-right">
    <button id="modeBtn" class="mode-btn">
      <i class="fa-solid fa-moon"></i>
    </button>

    <div class="menu">
      <i class="fa-solid fa-bars" onclick="toggleMenu()"></i>
      <div class="menu-dropdown" id="menuDropdown">
        <a href="#">Profile</a>
        <a href="#">Help</a>
        <a href="#" onclick="logout()">Logout</a>
      </div>
    </div>
  </div>
</nav>

<!-- WELCOME -->
<div class="welcome-box">
  <div>
    <h3>Welcome, Shiv</h3>
  </div>
  <div class="welcome-right">
    <h6 id="teacherInstitution">gamer</h6>
    <p id="teacherDate">35625</p>
  </div>
</div>

<!-- MAIN -->
<div class="main-container">

  <div class="updates-panel">
    <h4>Academic Updates</h4>
    <div id="updatesList"></div>
  </div>

  <div class="right-content">

    <div class="actions-grid">

      <div class="card-box"><i class="fa-solid fa-users"></i><h5>Teams</h5></div>
      <div class="card-box"><i class="fa-solid fa-circle-question"></i><h5>Doubts</h5></div>
      <div class="card-box"><i class="fa-solid fa-pen"></i><h5>Quizzes</h5></div>
      <div class="card-box"><i class="fa-solid fa-file-lines"></i><h5>Assignments</h5></div>
      <div class="card-box"><i class="fa-solid fa-book"></i><h5>Study Materials</h5></div>
      <div class="card-box"><i class="fa-solid fa-star"></i><h5>Solutions Feedback</h5></div>

    </div>

   <div class="announcement-section mt-5">
  <h4>Create Announcement</h4>

  <form id="announcementForm">

    <div class="mb-3">
      <label class="form-label">Select Team</label>
      <select class="form-select" id="teamSelect" required>
        <option value="">Select team</option>
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Title</label>
      <input type="text" class="form-control" id="announcementTitle" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Content</label>
      <textarea class="form-control" rows="4" id="announcementContent" required></textarea>
    </div>

    <button type="submit" class="btn btn-primary w-100">
      Post Announcement
    </button>

  </form>
</div>

  </div>

</div>

<script>
const SUPABASE_URL = "https://jaetijisqgecxqgcqget.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphZXRpamlzcWdlY3hxZ2NxZ2V0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NTIxMDcsImV4cCI6MjA4NjIyODEwN30.9N66bJYHvB2JJIUESX-EQLtQM2Grk9R9xSY04dnexXk";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ---------- MODE ---------- */
document.getElementById("modeBtn").addEventListener("click", () => {
  document.body.classList.toggle("dark-mode");
  document.body.classList.toggle("light-mode");
});

/* ---------- MENU ---------- */
function toggleMenu(){
  document.getElementById("menuDropdown").classList.toggle("show-menu");
}

/* ---------- LOGOUT ---------- */
async function logout(){
  await supabase.auth.signOut();
  window.location.href = "login.html";
}

/* ---------- LOAD USER ---------- */
async function loadUser(){

  const { data: { user } } = await supabase.auth.getUser();
  if(!user){
    window.location.href="login.html";
    return;
  }

  const { data } = await supabase
    .from("users")
    .select("name,institution")
    .eq("id",user.id)
    .single();

  document.getElementById("teacherName").innerText = data?.name || "Teacher";
  document.getElementById("teacherInstitution").innerText = data?.institution || "";

  const today = new Date();
  document.getElementById("teacherDate").innerText =
    today.toLocaleDateString("en-IN",{weekday:"long",year:"numeric",month:"long",day:"numeric"});
}

loadUser();

/* ---------- ANNOUNCEMENT ---------- */
document.getElementById("announcementForm")
.addEventListener("submit", async(e)=>{
  e.preventDefault();

  const { data:{user} } = await supabase.auth.getUser();

  await supabase.from("announcements").insert([{
    title: document.getElementById("title").value,
    content: document.getElementById("content").value,
    posted_by: user.id
  }]);

  alert("Announcement Posted");
  e.target.reset();
});



async function loadTeacherTeams() {

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return;

  const { data: teams, error } = await supabase
    .from("teams")
    .select("id, name")
    .eq("teacher_id", user.id);

  if (error) {
    console.log(error);
    return;
  }

  const select = document.getElementById("teamSelect");
  select.innerHTML = '<option value="">Select team</option>';

  teams.forEach(team => {
    const option = document.createElement("option");
    option.value = team.id;
    option.textContent = team.name;
    select.appendChild(option);
  });
}

document.getElementById("announcementForm")
.addEventListener("submit", async function(e) {

  e.preventDefault();

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return;

  const teamId = document.getElementById("teamSelect").value;
  const title = document.getElementById("announcementTitle").value.trim();
  const content = document.getElementById("announcementContent").value.trim();

  if (!teamId || !title || !content) {
    alert("All fields are required");
    return;
  }

  // get teacher institution automatically
  const { data: teacherData } = await supabase
    .from("users")
    .select("institution")
    .eq("id", user.id)
    .single();

  const { error } = await supabase
    .from("announcements")
    .insert([{
      title: title,
      content: content,
      posted_by: user.id,
      team_id: teamId,
      institution: teacherData.institution,
      target_type: "team"
    }]);

  if (error) {
    console.log(error);
    alert("Error posting announcement");
    return;
  }

  alert("Announcement posted successfully");
  document.getElementById("announcementForm").reset();
});


async function loadTeacher() {

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return;

  const { data, error } = await supabase
    .from("users")
    .select("name, institution")
    .eq("id", user.id)
    .single();

  if (error) {
    console.log(error);
    return;
  }

  document.getElementById("teacherName").innerText = data.name;
}

document.addEventListener("DOMContentLoaded", () => {
  loadTeacher();
  loadTeacherTeams();
});

document.addEventListener("DOMContentLoaded", () => {
  loadTeacher();
});
</script>

</body>
</html>