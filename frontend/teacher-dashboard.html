<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teacher Dashboard | EduResolve</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="teacher_style.css">
</head>

<body class="dark-mode">

<nav class="navbar-custom">
  <div class="logo">
    <i class="fa-solid fa-graduation-cap"></i> EduResolve
  </div>

  <div class="nav-center">
    <a href="#">Account</a>
    <a href="#">My Courses</a>
    <a href="#">Search</a>
  </div>

  <div class="nav-right">
    <button class="mode-btn" onclick="toggleMode()">
      <i class="fa-solid fa-moon"></i>
    </button>

    <div class="menu">
      <i class="fa-solid fa-bars" onclick="toggleMenu()"></i>
      <div class="menu-dropdown" id="menuDropdown">
        <a href="#">Profile</a>
        <a href="#">Help</a>
        <a href="#" onclick="logoutUser()">Logout</a>
      </div>
    </div>
  </div>
</nav>

<div class="welcome-section">
  <div>
    <h3>Welcome, <span id="teacherName"></span></h3>
  </div>
  <div>
    <h6 id="teacherInstitution"></h6>
    <p id="teacherDate"></p>
  </div>
</div>

<div class="dashboard-container">

  <div class="updates-panel">
    <h4>Academic Updates</h4>
    <div class="update-item">Holiday declared on Monday</div>
    <div class="update-item">Marks upload deadline approaching</div>
    <div class="update-item">Semester exam schedule released</div>
  </div>

  <div>

    <div class="actions-panel">

      <div class="action-card" onclick="window.location.href='teacher_teams.html'">
        <i class="fa-solid fa-users"></i>
        <h5>Teams</h5>
        <p>Manage student groups</p>
      </div>

      <div class="action-card">
        <i class="fa-solid fa-circle-question"></i>
        <h5>Doubts</h5>
        <p>Respond to student queries</p>
      </div>

      <div class="action-card">
        <i class="fa-solid fa-pen"></i>
        <h5>Quizzes</h5>
        <p>Create and manage quizzes</p>
      </div>

      <div class="action-card">
        <i class="fa-solid fa-file-lines"></i>
        <h5>Assignments</h5>
        <p>Assign and evaluate work</p>
      </div>

      <div class="action-card">
        <i class="fa-solid fa-book"></i>
        <h5>Study Materials</h5>
        <p>Upload resources</p>
      </div>

      <div class="action-card">
        <i class="fa-solid fa-star"></i>
        <h5>Solutions Feedback</h5>
        <p>Review feedback</p>
      </div>

    </div>

    <div class="announcement-section mt-5">
      <h4>Create Announcement</h4>

      <form id="announcementForm">

        <div class="mb-3">
          <label>Select Team</label>
          <select class="form-select" id="teamSelect" required>
            <option value="">Select team</option>
          </select>
        </div>

        <div class="mb-3">
          <label>Title</label>
          <input type="text" class="form-control" id="announcementTitle" required>
        </div>

        <div class="mb-3">
          <label>Content</label>
          <textarea class="form-control" rows="4" id="announcementContent" required></textarea>
        </div>

        <button type="submit" class="btn explore-btn">
          Post Announcement
        </button>

      </form>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>

/* ========= SUPABASE CONFIG ========= */

const SUPABASE_URL = "YOUR_SUPABASE_URL";
const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";

const supabase = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* ========= MODE ========= */

function toggleMode() {
  document.body.classList.toggle("dark-mode");
  document.body.classList.toggle("light-mode");
}

function toggleMenu() {
  document.getElementById("menuDropdown").classList.toggle("show-menu");
}

/* ========= AUTH + ROLE PROTECTION ========= */

async function protectTeacherPage() {

  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    window.location.href = "login.html";
    return null;
  }

  const { data } = await supabase
    .from("users")
    .select("role")
    .eq("id", user.id)
    .single();

  if (!data || data.role !== "teacher") {
    window.location.href = "login.html";
    return null;
  }

  return user;
}

/* ========= LOAD PROFILE ========= */

async function loadTeacherProfile() {

  const user = await protectTeacherPage();
  if (!user) return;

  const { data } = await supabase
    .from("users")
    .select("name, institution")
    .eq("id", user.id)
    .single();

  document.getElementById("teacherName").innerText = data?.name || "Teacher";
  document.getElementById("teacherInstitution").innerText = data?.institution || "";

  const today = new Date();
  document.getElementById("teacherDate").innerText =
    today.toLocaleDateString("en-IN", {
      weekday: "long",
      year: "numeric",
      month: "long",
      day: "numeric"
    });
}

/* ========= LOAD TEAMS ========= */

async function loadTeacherTeams() {

  const user = await protectTeacherPage();
  if (!user) return;

  const { data: teams } = await supabase
    .from("teams")
    .select("id, name")
    .eq("teacher_id", user.id);

  const select = document.getElementById("teamSelect");
  select.innerHTML = '<option value="">Select team</option>';

  teams?.forEach(team => {
    const option = document.createElement("option");
    option.value = team.id;
    option.textContent = team.name;
    select.appendChild(option);
  });
}

/* ========= POST ANNOUNCEMENT ========= */

document.getElementById("announcementForm")
.addEventListener("submit", async function(e) {

  e.preventDefault();

  const user = await protectTeacherPage();
  if (!user) return;

  const teamId = document.getElementById("teamSelect").value;
  const title = document.getElementById("announcementTitle").value.trim();
  const content = document.getElementById("announcementContent").value.trim();

  const { error } = await supabase
    .from("announcements")
    .insert([{
      title,
      content,
      posted_by: user.id,
      team_id: teamId
    }]);

  if (error) {
    alert("Error posting announcement");
    console.log(error);
    return;
  }

  alert("Announcement posted");
  document.getElementById("announcementForm").reset();
});

/* ========= LOGOUT ========= */

async function logoutUser() {
  await supabase.auth.signOut();
  window.location.href = "login.html";
}

/* ========= INIT ========= */

document.addEventListener("DOMContentLoaded", () => {
  loadTeacherProfile();
  loadTeacherTeams();
});

</script>

</body>
</html>